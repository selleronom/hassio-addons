#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Configures Garage S3
# ==============================================================================

readonly CONFIG_PATH="/data/garage.toml"
readonly METADATA_DIR="/data/meta"
readonly DATA_DIR="/data/data"
readonly SECRETS_FILE="/data/.garage_secrets"

bashio::log.info "Initializing Garage S3..."

# Create directories
mkdir -p "${METADATA_DIR}" "${DATA_DIR}"

# Load or generate persistent secrets
load_or_generate_secret() {
    local key="$1"
    local value=""

    # Check if secrets file exists and contains this key
    if [ -f "${SECRETS_FILE}" ]; then
        value=$(grep "^${key}=" "${SECRETS_FILE}" 2>/dev/null | cut -d'=' -f2-) || value=""
    fi

    # If no stored value, generate new
    if [ -z "${value}" ]; then
        if [ "${key}" = "rpc_secret" ]; then
            value=$(openssl rand -hex 32)
        else
            value=$(openssl rand -base64 32)
        fi
        bashio::log.info "Generated new ${key}"

        # Persist to secrets file
        if [ -f "${SECRETS_FILE}" ]; then
            # Remove old entry if exists, then append
            grep -v "^${key}=" "${SECRETS_FILE}" > "${SECRETS_FILE}.tmp" 2>/dev/null || true
            mv "${SECRETS_FILE}.tmp" "${SECRETS_FILE}"
        fi
        echo "${key}=${value}" >> "${SECRETS_FILE}"
        chmod 600 "${SECRETS_FILE}"
    fi

    echo "${value}"
}

# Load or generate secrets (persistent across restarts)
RPC_SECRET=$(load_or_generate_secret "rpc_secret")
ADMIN_TOKEN=$(load_or_generate_secret "admin_token")
METRICS_TOKEN=$(load_or_generate_secret "metrics_token")

bashio::log.info "Using persistent secrets from ${SECRETS_FILE}"

# Get S3 region
S3_REGION=$(bashio::config 's3_region')

# Generate garage.toml
bashio::log.info "Generating Garage configuration..."
cat > "${CONFIG_PATH}" <<EOF
metadata_dir = "${METADATA_DIR}"
data_dir = "${DATA_DIR}"
db_engine = "sqlite"
replication_factor = 1

rpc_bind_addr = "[::]:3901"
rpc_public_addr = "127.0.0.1:3901"
rpc_secret = "${RPC_SECRET}"

[s3_api]
s3_region = "${S3_REGION}"
api_bind_addr = "[::]:3900"
root_domain = ".s3.garage"

[admin]
api_bind_addr = "[::]:3903"
admin_token = "${ADMIN_TOKEN}"
metrics_token = "${METRICS_TOKEN}"
EOF

# Start Garage server in background to initialize
bashio::log.info "Starting Garage server for initialization..."
garage -c "${CONFIG_PATH}" server &
GARAGE_PID=$!

# Wait for Garage to be ready
sleep 5

# Function to create key and log credentials
create_key() {
    local key_name="$1"
    local create_output

    bashio::log.info "Creating new key: ${key_name}"
    create_output=$(garage -c "${CONFIG_PATH}" key create "${key_name}" 2>&1)
    if [ $? -eq 0 ]; then
        bashio::log.info "Key created successfully:"
        echo "${create_output}" | while read -r line; do
            bashio::log.info "  ${line}"
        done
        return 0
    else
        bashio::log.error "Failed to create key: ${key_name}"
        return 1
    fi
}

# Initialize cluster layout if needed
initialize_layout() {
    local node_id
    node_id=$(garage -c "${CONFIG_PATH}" status 2>/dev/null | grep "127.0.0.1:3901" | awk '{print $1}')

    if [ -z "${node_id}" ]; then
        bashio::log.warning "Could not get node ID, will retry on next start"
        return 1
    fi

    bashio::log.info "Node ID: ${node_id}"

    # Check if layout is already applied
    if garage -c "${CONFIG_PATH}" layout show 2>/dev/null | grep -q "${node_id}"; then
        bashio::log.info "Layout already configured"
        return 0
    fi

    # Assign and apply layout
    bashio::log.info "Assigning layout to node ${node_id}..."
    garage -c "${CONFIG_PATH}" layout assign -z dc1 -c 1G "${node_id}" || true

    bashio::log.info "Applying layout..."
    garage -c "${CONFIG_PATH}" layout apply --version 1 || true

    # Wait for layout to propagate
    bashio::log.info "Waiting for layout to propagate..."
    sleep 5

    return 0
}

# Ensure keys and buckets exist
ensure_keys_and_buckets() {
    bashio::log.info "Ensuring keys and buckets from configuration..."
    local keys_len
    keys_len=$(bashio::config 'keys|length')

    for i in $(seq 0 $((keys_len-1))); do
        local name
        name=$(bashio::config "keys[${i}].name")

        bashio::log.info "Ensuring key exists: ${name}"

        # Check if key exists in Garage
        if ! garage -c "${CONFIG_PATH}" key info "${name}" >/dev/null 2>&1; then
            create_key "${name}" || continue
        fi

        # Ensure buckets and permissions
        local buckets_len
        buckets_len=$(bashio::config "keys[${i}].buckets|length")
        for j in $(seq 0 $((buckets_len-1))); do
            local bucket
            bucket=$(bashio::config "keys[${i}].buckets[${j}]")
            bashio::log.info "Ensuring bucket + allow: ${bucket} -> ${name}"

            garage -c "${CONFIG_PATH}" bucket create "${bucket}" >/dev/null 2>&1 || true
            garage -c "${CONFIG_PATH}" bucket allow \
                --read --write --owner \
                "${bucket}" \
                --key "${name}" 2>/dev/null || true
        done
    done
}

# Main initialization logic
bashio::log.info "Checking cluster state..."

if initialize_layout; then
    ensure_keys_and_buckets
    touch /data/.initialized
    bashio::log.info "Initialization complete!"
else
    bashio::log.warning "Layout initialization failed, will retry on next start"
fi

# Stop the background server
kill ${GARAGE_PID} 2>/dev/null || true
wait ${GARAGE_PID} 2>/dev/null || true

bashio::log.info "Initialization finished"
