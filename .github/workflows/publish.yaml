name: Publish

on:
    release:
        types:
            - published
    workflow_dispatch: {}

jobs:
    information:
        name: Gather add-on information
        runs-on: ubuntu-latest
        outputs:
            architectures: ${{ steps.information.outputs.architectures }}
            build: ${{ steps.information.outputs.build }}
            description: ${{ steps.information.outputs.description }}
            name: ${{ steps.information.outputs.name }}
            slug: ${{ steps.information.outputs.slug }}
            target: ${{ steps.information.outputs.target }}
            version: ${{ steps.override.outputs.version }}
        steps:
            - name: ‚§µÔ∏è Check out code from GitHub
              uses: actions/checkout@v4

            - name: üöÄ Run add-on information action
              id: information
              uses: frenck/action-addon-information@v1.4.2

            - name: üöÄ Process version from release
              id: override
              run: |
                version="${{ steps.information.outputs.version }}"
                if [[ ! -z "${{ github.event.release.tag_name }}" ]]; then
                  version="${{ github.event.release.tag_name }}"
                  version="${version#v}"
                fi
                echo "version=${version}" >> $GITHUB_OUTPUT

    build:
        name: Build and publish
        needs: information
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
            id-token: write
        strategy:
            matrix:
                architecture: ${{ fromJson(needs.information.outputs.architectures) }}
        steps:
            - name: ‚§µÔ∏è Check out code from GitHub
              uses: actions/checkout@v6

            - name: üèó Set up build cache
              id: cache
              uses: actions/cache@v4
              with:
                path: /tmp/.docker-cache
                key: docker-${{ matrix.architecture }}-${{ github.sha }}
                restore-keys: |
                    docker-${{ matrix.architecture }}

            - name: üèó Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: üèó Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: ‚ÑπÔ∏è Compose build flags
              id: flags
              run: |
                echo "date=$(date +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
                from=$(yq --no-colors eval ".build_from.${{ matrix.architecture }}" "${{ needs.information.outputs.target }}/build.yaml")
                echo "from=${from}" >> $GITHUB_OUTPUT

            - name: üß© Compose image name
              run: |
                echo "GITHUB_IMAGE=ghcr.io/${{ github.repository_owner }}/{arch}-addon-${{ needs.information.outputs.slug }}" >> $GITHUB_ENV

            - name: üèó Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.repository_owner }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: üöÄ Build and push
              uses: home-assistant/builder@2025.09.0
              with:
                args: |
                    --${{ matrix.architecture }} \
                    --target ${{ needs.information.outputs.target }} \
                    --image "$GITHUB_IMAGE" \
                    --docker-hub ghcr.io/${{ github.repository_owner }} \
                    --version ${{ needs.information.outputs.version }} \
                    --cosign
              env:
                CAS_API_KEY: ${{ secrets.CAS_API_KEY }}
