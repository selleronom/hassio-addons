name: Update Add-on Version

on:
    pull_request_target:
        paths:
            - "**/Dockerfile"
    workflow_dispatch: {}

jobs:
    update-version:
        name: Update config.yaml version
        runs-on: ubuntu-latest
        if: github.actor == 'renovate[bot]' || github.event_name == 'workflow_dispatch'
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: ‚§µÔ∏è Check out code
              uses: actions/checkout@v6
              with:
                ref: ${{ github.event.pull_request.head.sha || github.ref }}
                token: ${{ secrets.GITHUB_TOKEN }}
                fetch-depth: 0

            - name: üì¶ Install yq
              run: |
                sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
                sudo chmod +x /usr/local/bin/yq

            - name: üìù Update add-on version
              id: version
              run: |
                # Determine base ref for comparison
                if [ "${{ github.event_name }}" = "pull_request_target" ]; then
                  BASE_REF="origin/${{ github.base_ref }}"
                else
                  BASE_REF="HEAD~1"
                fi

                # Run the version update script
                chmod +x .github/scripts/update-addon-version.sh
                .github/scripts/update-addon-version.sh "$BASE_REF"

            - name: üöÄ Commit changes
              if: steps.version.outputs.updated == 'true'
              uses: stefanzweifel/git-auto-commit-action@v7
              with:
                commit_message: "‚¨ÜÔ∏è Bump ${{ steps.version.outputs.addon_dir }} version to ${{ steps.version.outputs.new_version }}"
                commit_user_name: "github-actions[bot]"
                commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
