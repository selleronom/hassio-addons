name: Update Add-on Version

on:
    pull_request:
        paths:
            - "**/Dockerfile"
    workflow_dispatch: {}

jobs:
    update-version:
        name: Update config.yaml version
        runs-on: ubuntu-latest
        if: github.actor == 'renovate[bot]' || github.event_name == 'workflow_dispatch'
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: â¤µï¸ Check out code
              uses: actions/checkout@v6
              with:
                ref: ${{ github.head_ref || github.ref }}
                token: ${{ secrets.GITHUB_TOKEN }}
                fetch-depth: 0

            - name: ğŸ“¦ Install yq
              run: |
                sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
                sudo chmod +x /usr/local/bin/yq

            - name: ğŸ” Detect changed add-on
              id: detect
              run: |
                # Find which add-on's Dockerfile changed
                if [ "${{ github.event_name }}" = "pull_request" ]; then
                    changed_file=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep 'Dockerfile' | head -n1)
                else
                    changed_file=$(git diff --name-only HEAD~1..HEAD | grep 'Dockerfile' | head -n1)
                fi

                if [ -z "$changed_file" ]; then
                    echo "No Dockerfile changes detected"
                    echo "addon_dir=" >> $GITHUB_OUTPUT
                    exit 0
                fi

                addon_dir=$(dirname "$changed_file")
                echo "addon_dir=${addon_dir}" >> $GITHUB_OUTPUT
                echo "Detected addon: ${addon_dir}"

            - name: ğŸ“ Update add-on version
              if: steps.detect.outputs.addon_dir != ''
              id: version
              run: |
                addon_dir="${{ steps.detect.outputs.addon_dir }}"
                dockerfile="${addon_dir}/Dockerfile"
                config_file="${addon_dir}/config.yaml"

                if [ ! -f "$config_file" ]; then
                    echo "Config file not found: $config_file"
                    exit 0
                fi

                # Get current config version
                current_config=$(yq eval '.version' "$config_file")
                echo "Current config version: $current_config"

                # Extract main package version from Dockerfile
                # Find the first renovate repology comment and get the package version on the next line
                main_pkg_version=""

                # Use grep to find renovate comment, then extract version from next line
                # Format: # renovate: datasource=repology depName=...
                #         package=version
                main_pkg_version=$(grep -A1 "# renovate:.*datasource=repology" "$dockerfile" | \
                    grep -oE '[a-z0-9_-]+==[0-9][^ \\]*|[a-z0-9_-]+=[0-9][^ \\]*' | \
                    head -n1 | \
                    sed 's/.*=//')

                if [ -n "$main_pkg_version" ]; then
                    echo "Found main package version (repology): $main_pkg_version"
                fi

                # If no repology package found, try github-releases pattern
                if [ -z "$main_pkg_version" ]; then
                    main_pkg_version=$(grep -A1 "# renovate:.*datasource=github-releases" "$dockerfile" | \
                        grep -oE 'VERSION=[^ ]+' | \
                        head -n1 | \
                        sed 's/VERSION=//' | \
                        sed 's/^v//')

                    if [ -n "$main_pkg_version" ]; then
                        echo "Found main package version (github): $main_pkg_version"
                    fi
                fi

                if [ -z "$main_pkg_version" ]; then
                    echo "Could not detect main package version, incrementing suffix only"
                    # Fallback: just increment suffix
                    if [[ "$current_config" =~ ^(.+)-([0-9]+)$ ]]; then
                        new_version="${BASH_REMATCH[1]}-$((BASH_REMATCH[2] + 1))"
                    else
                        new_version="${current_config}-1"
                    fi
                else
                    # Check if main package version changed
                    if [[ "$current_config" =~ ^(.+)-([0-9]+)$ ]]; then
                        current_base="${BASH_REMATCH[1]}"
                        current_suffix="${BASH_REMATCH[2]}"
                    else
                        current_base="$current_config"
                        current_suffix="0"
                    fi

                    if [ "$current_base" = "$main_pkg_version" ]; then
                        # Same package version, increment suffix
                        new_version="${main_pkg_version}-$((current_suffix + 1))"
                    else
                        # New package version, reset to -1
                        new_version="${main_pkg_version}-1"
                    fi
                fi

                echo "New version: $new_version"

                # Update config.yaml
                yq eval -i ".version = \"${new_version}\"" "$config_file"

                echo "updated=true" >> $GITHUB_OUTPUT
                echo "old_version=${current_config}" >> $GITHUB_OUTPUT
                echo "new_version=${new_version}" >> $GITHUB_OUTPUT

            - name: ğŸš€ Commit changes
              if: steps.version.outputs.updated == 'true'
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                commit_message: "â¬†ï¸ Bump ${{ steps.detect.outputs.addon_dir }} version to ${{ steps.version.outputs.new_version }}"
                commit_user_name: "github-actions[bot]"
                commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
