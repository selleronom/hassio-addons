name: CI

on:
    push:
        branches:
            - master
    pull_request: {}
    workflow_dispatch: {}

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    find-addons:
        name: Find addons to build
        runs-on: ubuntu-latest
        outputs:
            addons: ${{ steps.addons.outputs.addons }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6
              with:
                fetch-depth: 0

            - name: ðŸ” Find addons
              id: addons
              run: |
                declare -a addons

                if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                  # Build all addons on manual trigger
                  addons=($(find . -maxdepth 2 -name "config.yaml" -not -path "./.github/*" | sed 's|./||' | cut -d'/' -f1 | sort -u))
                else
                  # Build only changed addons on push/PR
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    base_ref="${{ github.event.pull_request.base.sha }}"
                    head_ref="${{ github.event.pull_request.head.sha }}"
                  else
                    if git rev-parse HEAD^ >/dev/null 2>&1; then
                      base_ref="HEAD^"
                      head_ref="HEAD"
                    else
                      # First commit, build all
                      addons=($(find . -maxdepth 2 -name "config.yaml" -not -path "./.github/*" | sed 's|./||' | cut -d'/' -f1 | sort -u))
                      base_ref=""
                    fi
                  fi

                  if [[ -n "$base_ref" ]]; then
                    changed_files=$(git diff --name-only ${base_ref} ${head_ref})
                    addons=($(echo "$changed_files" | grep -E '^[^/]+/' | cut -d'/' -f1 | sort -u))

                    # If no addons changed, check if workflow file changed
                    if [[ ${#addons[@]} -eq 0 ]] && echo "$changed_files" | grep -q ".github/workflows"; then
                      addons=($(find . -maxdepth 2 -name "config.yaml" -not -path "./.github/*" | sed 's|./||' | cut -d'/' -f1 | sort -u))
                    fi
                  fi
                fi

                # Verify each addon has config.yaml
                declare -a valid_addons
                for addon in "${addons[@]}"; do
                  if [[ -f "${addon}/config.yaml" ]]; then
                    valid_addons+=("$addon")
                  fi
                done

                # Convert to JSON array
                if [[ ${#valid_addons[@]} -eq 0 ]]; then
                  echo "addons=[]" >> $GITHUB_OUTPUT
                  echo "No addons to build"
                else
                  addons_json=$(printf '%s\n' "${valid_addons[@]}" | jq -R . | jq -s -c .)
                  echo "addons=${addons_json}" >> $GITHUB_OUTPUT
                  echo "Found addons to build: ${addons_json}"
                fi

    information:
        name: Get ${{ matrix.addon }} information
        needs: find-addons
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
        outputs:
            architectures: ${{ steps.information.outputs.architectures }}
            build: ${{ steps.information.outputs.build }}
            description: ${{ steps.information.outputs.description }}
            name: ${{ steps.information.outputs.name }}
            slug: ${{ steps.information.outputs.slug }}
            target: ${{ steps.information.outputs.target }}
            version: ${{ steps.information.outputs.version }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ðŸš€ Run add-on information action
              id: information
              uses: frenck/action-addon-information@v1.4.2
              with:
                path: "./${{ matrix.addon }}"

    lint-addon:
        name: Lint ${{ matrix.addon }}
        needs:
            - find-addons
            - information
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ðŸš€ Run Add-on Lint
              uses: frenck/action-addon-linter@v2.15.1
              with:
                path: "./${{ matrix.addon }}"

    lint-hadolint:
        name: Hadolint ${{ matrix.addon }}
        needs:
            - find-addons
            - information
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ðŸš€ Run Hadolint
              uses: hadolint/hadolint-action@v3.1.0
              with:
                dockerfile: "./${{ matrix.addon }}/Dockerfile"

    build:
        name: Build ${{ matrix.addon }} (${{ matrix.architecture }})
        needs:
            - find-addons
            - information
            - lint-addon
            - lint-hadolint
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            fail-fast: false
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
                architecture:
                    - aarch64
                    - amd64
                    - armhf
                    - armv7
                    - i386
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ðŸ“ Get addon information
              id: addon-info
              uses: frenck/action-addon-information@v1.4.2
              with:
                path: "./${{ matrix.addon }}"

            - name: âœ‹ Check if architecture is supported
              id: supported
              run: |
                if echo '${{ steps.addon-info.outputs.architectures }}' | jq -e 'map(select(. == "${{ matrix.architecture }}")) | length > 0' > /dev/null; then
                  echo "build=true" >> $GITHUB_OUTPUT
                else
                  echo "build=false" >> $GITHUB_OUTPUT
                  echo "â­ï¸ Skipping ${{ matrix.addon }} for ${{ matrix.architecture }} (architecture not supported)"
                fi

            - name: ðŸ— Set up build cache
              if: steps.supported.outputs.build == 'true'
              uses: actions/cache@v4
              with:
                path: /tmp/.docker-cache
                key: docker-${{ matrix.addon }}-${{ matrix.architecture }}-${{ github.sha }}
                restore-keys: |
                    docker-${{ matrix.addon }}-${{ matrix.architecture }}

            - name: ðŸ— Set up QEMU
              if: steps.supported.outputs.build == 'true'
              uses: docker/setup-qemu-action@v3

            - name: ðŸ— Set up Docker Buildx
              if: steps.supported.outputs.build == 'true'
              uses: docker/setup-buildx-action@v3

            - name: â„¹ï¸ Compose build flags
              if: steps.supported.outputs.build == 'true'
              id: flags
              run: |
                echo "date=$(date +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
                if [[ -f "${{ matrix.addon }}/build.yaml" ]]; then
                  from=$(yq --no-colors eval ".build_from.${{ matrix.architecture }}" "${{ matrix.addon }}/build.yaml" 2>/dev/null || echo "null")
                  if [[ "$from" != "null" ]]; then
                    echo "from=${from}" >> $GITHUB_OUTPUT
                  fi
                fi

            - name: ðŸš€ Build
              if: steps.supported.outputs.build == 'true'
              uses: home-assistant/builder@2025.09.0
              with:
                args: |
                    --test \
                    --${{ matrix.architecture }} \
                    --target ${{ matrix.addon }} \
                    --docker-hub ghcr.io/${{ github.repository_owner }} \
                    --no-latest \
                    --no-cache
