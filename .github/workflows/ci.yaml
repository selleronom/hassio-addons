name: CI

on:
    push:
        branches:
            - master
    pull_request: {}
    workflow_dispatch: {}

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        name: Build ${{ matrix.addon }} (${{ matrix.architecture }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                addon:
                    - caddy-proxy
                    - garage
                    - isponsorblocktv
                    - jellyfin
                    - qbittorrent
                    - syncthing
                architecture:
                    - aarch64
                    - amd64
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ðŸ“ Get addon information
              id: info
              uses: frenck/action-addon-information@v1.4.2
              with:
                path: "./${{ matrix.addon }}"

            - name: âœ‹ Check if architecture is supported
              id: check
              run: |
                if echo '${{ steps.info.outputs.architectures }}' | jq -e 'map(select(. == "${{ matrix.architecture }}")) | length > 0' > /dev/null; then
                  echo "build=true" >> $GITHUB_OUTPUT
                else
                  echo "build=false" >> $GITHUB_OUTPUT
                fi

            - name: ðŸš€ Run Add-on Lint
              if: steps.check.outputs.build == 'true'
              uses: frenck/action-addon-linter@v2.15.1
              with:
                path: "./${{ matrix.addon }}"

            - name: ðŸš€ Run Hadolint
              if: steps.check.outputs.build == 'true'
              uses: hadolint/hadolint-action@v3.1.0
              with:
                dockerfile: "./${{ matrix.addon }}/Dockerfile"

            - name: ðŸ— Set up build cache
              if: steps.check.outputs.build == 'true'
              uses: actions/cache@v4
              with:
                path: /tmp/.docker-cache
                key: docker-${{ matrix.addon }}-${{ matrix.architecture }}-${{ github.sha }}
                restore-keys: |
                    docker-${{ matrix.addon }}-${{ matrix.architecture }}

            - name: ðŸ— Set up QEMU
              if: steps.check.outputs.build == 'true'
              uses: docker/setup-qemu-action@v3

            - name: ðŸ— Set up Docker Buildx
              if: steps.check.outputs.build == 'true'
              uses: docker/setup-buildx-action@v3

            - name: â„¹ï¸ Compose build flags
              if: steps.check.outputs.build == 'true'
              id: flags
              run: |
                echo "date=$(date +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
                if [[ -f "${{ matrix.addon }}/build.yaml" ]]; then
                  from=$(yq --no-colors eval ".build_from.${{ matrix.architecture }}" "${{ matrix.addon }}/build.yaml")
                  echo "from=${from}" >> $GITHUB_OUTPUT
                fi

            - name: ðŸš€ Build
              if: steps.check.outputs.build == 'true'
              uses: home-assistant/builder@2025.09.0
              with:
                args: |
                    --test \
                    --${{ matrix.architecture }} \
                    --target ${{ matrix.addon }} \
                    --docker-hub ghcr.io/${{ github.repository_owner }} \
                    --no-latest \
                    --no-cache
