name: CI

on:
    push:
        branches:
            - master
    pull_request: {}
    workflow_dispatch: {}

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    find-addons:
        name: Find addons to build
        runs-on: ubuntu-latest
        outputs:
            addons: ${{ steps.addons.outputs.addons }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6
              with:
                fetch-depth: 0

            - name: ğŸ” Find addons
              id: addons
              run: |
                declare -a addons

                if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                  addons=($(find . -maxdepth 2 -name "config.yaml" -not -path "./.github/*" | sed 's|./||' | cut -d'/' -f1 | sort -u))
                else
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    base_ref="${{ github.event.pull_request.base.sha }}"
                    head_ref="${{ github.event.pull_request.head.sha }}"
                  else
                    if git rev-parse HEAD^ >/dev/null 2>&1; then
                      base_ref="HEAD^"
                      head_ref="HEAD"
                    else
                      addons=($(find . -maxdepth 2 -name "config.yaml" -not -path "./.github/*" | sed 's|./||' | cut -d'/' -f1 | sort -u))
                      base_ref=""
                    fi
                  fi

                  if [[ -n "$base_ref" ]]; then
                    changed_files=$(git diff --name-only ${base_ref} ${head_ref})
                    addons=($(echo "$changed_files" | grep -E '^[^/]+/' | cut -d'/' -f1 | sort -u))

                    if [[ ${#addons[@]} -eq 0 ]] && echo "$changed_files" | grep -q ".github/workflows"; then
                      addons=($(find . -maxdepth 2 -name "config.yaml" -not -path "./.github/*" | sed 's|./||' | cut -d'/' -f1 | sort -u))
                    fi
                  fi
                fi

                declare -a valid_addons
                for addon in "${addons[@]}"; do
                  if [[ -f "${addon}/config.yaml" ]]; then
                    valid_addons+=("$addon")
                  fi
                done

                if [[ ${#valid_addons[@]} -eq 0 ]]; then
                  echo "addons=[]" >> $GITHUB_OUTPUT
                  echo "No addons to build"
                else
                  addons_json=$(printf '%s\n' "${valid_addons[@]}" | jq -R . | jq -s -c .)
                  echo "addons=${addons_json}" >> $GITHUB_OUTPUT
                  echo "Found addons to build: ${addons_json}"
                fi

    lint-addon:
        name: Lint ${{ matrix.addon }}
        needs: find-addons
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ğŸš€ Run Add-on Lint
              uses: frenck/action-addon-linter@v2.15.1
              with:
                path: "./${{ matrix.addon }}"

    lint-hadolint:
        name: Hadolint ${{ matrix.addon }}
        needs: find-addons
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ğŸš€ Run Hadolint
              uses: hadolint/hadolint-action@v3.1.0
              with:
                dockerfile: "./${{ matrix.addon }}/Dockerfile"

    build:
        name: Build ${{ matrix.addon }} (${{ matrix.architecture }})
        needs:
            - find-addons
            - lint-addon
            - lint-hadolint
        runs-on: ubuntu-latest
        if: needs.find-addons.outputs.addons != '[]'
        strategy:
            fail-fast: false
            matrix:
                addon: ${{ fromJson(needs.find-addons.outputs.addons) }}
                architecture:
                    - aarch64
                    - amd64
                    - armhf
                    - armv7
                    - i386
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ğŸ“ Get addon information
              id: info
              uses: frenck/action-addon-information@v1.4.2
              with:
                path: "./${{ matrix.addon }}"

            - name: âœ‹ Check if architecture is supported
              id: check
              run: |
                if echo '${{ steps.info.outputs.architectures }}' | jq -e 'map(select(. == "${{ matrix.architecture }}")) | length > 0' > /dev/null; then
                  echo "supported=true" >> $GITHUB_OUTPUT
                  echo "Building ${{ steps.info.outputs.name }} v${{ steps.info.outputs.version }} for ${{ matrix.architecture }}"
                else
                  echo "supported=false" >> $GITHUB_OUTPUT
                  echo "â­ï¸ Skipping ${{ matrix.addon }} for ${{ matrix.architecture }}"
                fi

            - name: ğŸ— Set up build cache
              if: steps.check.outputs.supported == 'true'
              uses: actions/cache@v4
              with:
                path: /tmp/.docker-cache
                key: docker-${{ matrix.addon }}-${{ matrix.architecture }}-${{ github.sha }}
                restore-keys: |
                    docker-${{ matrix.addon }}-${{ matrix.architecture }}

            - name: ğŸ— Set up QEMU
              if: steps.check.outputs.supported == 'true'
              uses: docker/setup-qemu-action@v3

            - name: ğŸ— Set up Docker Buildx
              if: steps.check.outputs.supported == 'true'
              uses: docker/setup-buildx-action@v3

            - name: ğŸš€ Build
              if: steps.check.outputs.supported == 'true'
              uses: home-assistant/builder@2025.09.0
              with:
                args: |
                    --test \
                    --${{ matrix.architecture }} \
                    --target ${{ steps.info.outputs.target }} \
                    --docker-hub ghcr.io/${{ github.repository_owner }} \
                    --no-latest \
                    --no-cache
