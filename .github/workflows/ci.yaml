name: CI

on:
    push:
        branches:
            - master
    pull_request: {}
    workflow_dispatch: {}

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        name: Build ${{ matrix.addon }} (${{ matrix.architecture }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                addon:
                    - caddy_proxy
                    - garage
                    - isponsorblocktv
                    - jellyfin
                    - qbittorrent
                    - syncthing
                architecture:
                    - aarch64
                    - amd64

        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ğŸ“ Get addon information
              id: info
              uses: frenck/action-addon-information@v1.4.2
              with:
                path: "./${{ matrix.addon }}"

            - name: ğŸ” Debug addon info
              run: |
                echo "Addon dir:  '${{ matrix.addon }}'"
                echo "Slug:       '${{ steps.info.outputs.slug }}'"
                echo "Target:     '${{ steps.info.outputs.target }}'"
                echo "Version:    '${{ steps.info.outputs.version }}'"
                echo "Archs:      '${{ steps.info.outputs.architectures }}'"

            - name: âœ‹ Check if architecture is supported
              id: arch
              run: |
                if echo '${{ steps.info.outputs.architectures }}' | jq -e 'map(select(. == "${{ matrix.architecture }}")) | length > 0' > /dev/null; then
                  echo "build=true" >> $GITHUB_OUTPUT
                else
                  echo "build=false" >> $GITHUB_OUTPUT
                  echo "Skip ${{ matrix.addon }} for ${{ matrix.architecture }} (not supported)"
                fi

            - name: ğŸš€ Run Add-on Lint
              if: steps.arch.outputs.build == 'true'
              uses: frenck/action-addon-linter@v2.15.1
              with:
                path: "./${{ matrix.addon }}"

            - name: ğŸš€ Run Hadolint
              if: steps.arch.outputs.build == 'true'
              uses: hadolint/hadolint-action@v3.1.0
              with:
                dockerfile: "./${{ matrix.addon }}/Dockerfile"

            - name: ğŸ— Set up build cache
              if: steps.arch.outputs.build == 'true'
              uses: actions/cache@v4
              with:
                path: /tmp/.docker-cache
                key: docker-${{ matrix.addon }}-${{ matrix.architecture }}-${{ github.sha }}
                restore-keys: |
                    docker-${{ matrix.addon }}-${{ matrix.architecture }}

            - name: ğŸ— Set up QEMU
              if: steps.arch.outputs.build == 'true'
              uses: docker/setup-qemu-action@v3

            - name: ğŸ— Set up Docker Buildx
              if: steps.arch.outputs.build == 'true'
              uses: docker/setup-buildx-action@v3

            - name: ğŸš€ Build
              if: steps.arch.outputs.build == 'true'
              uses: home-assistant/builder@2025.09.0
              with:
                args: |
                    --test \
                    --${{ matrix.architecture }} \
                    --target /data/${{ matrix.addon }} \
                    --image hassio-addons_${{ matrix.addon }} \
                    --load \
                    --no-latest \
                    --no-cache
