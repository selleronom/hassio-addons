name: CI

on:
    push:
        branches:
            - master
    pull_request: {}
    workflow_dispatch: {}

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    information:
        name: Gather add-on information
        runs-on: ubuntu-latest
        outputs:
            architectures: ${{ steps.information.outputs.architectures }}
            build: ${{ steps.information.outputs.build }}
            description: ${{ steps.information.outputs.description }}
            name: ${{ steps.information.outputs.name }}
            slug: ${{ steps.information.outputs.slug }}
            target: ${{ steps.information.outputs.target }}
            version: ${{ steps.information.outputs.version }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v4

            - name: ðŸš€ Run add-on information action
              id: information
              uses: frenck/action-addon-information@v1.4.2

    lint-addon:
        name: Lint Add-on
        needs: information
        runs-on: ubuntu-latest
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v4

            - name: ðŸš€ Run Add-on Lint
              uses: frenck/action-addon-linter@v2.15.1
              with:
                path: "./${{ needs.information.outputs.target }}"

    lint-hadolint:
        name: Hadolint
        needs: information
        runs-on: ubuntu-latest
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v4

            - name: ðŸš€ Run Hadolint
              uses: hadolint/hadolint-action@v3.1.0
              with:
                dockerfile: "./${{ needs.information.outputs.target }}/Dockerfile"

    build:
        name: Test build
        needs:
            - information
            - lint-addon
            - lint-hadolint
        runs-on: ubuntu-latest
        strategy:
            matrix:
                architecture: ${{ fromJson(needs.information.outputs.architectures) }}
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v6

            - name: ðŸ— Set up build cache
              id: cache
              uses: actions/cache@v4
              with:
                path: /tmp/.docker-cache
                key: docker-${{ matrix.architecture }}-${{ github.sha }}
                restore-keys: |
                    docker-${{ matrix.architecture }}

            - name: ðŸ— Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: ðŸ— Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: â„¹ï¸ Compose build flags
              id: flags
              run: |
                echo "date=$(date +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
                target_file="${{ needs.information.outputs.target }}/build.yaml"
                from=$(yq --no-colors eval ".build_from.${{ matrix.architecture }}" "$target_file")
                echo "from=${from}" >> $GITHUB_OUTPUT

            - name: ðŸš€ Build
              uses: home-assistant/builder@2025.09.0
              with:
                args: |
                    --test \
                    --${{ matrix.architecture }} \
                    --target ${{ needs.information.outputs.target }} \
                    --docker-hub ghcr.io/${{ github.repository_owner }} \
                    --no-latest \
                    --no-cache
